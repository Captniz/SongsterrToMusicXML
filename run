#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"
VENV_DIR="$SCRIPT_DIR/.venv"

if command -v python3 >/dev/null 2>&1; then
  PYTHON_BIN="python3"
elif command -v python >/dev/null 2>&1; then
  PYTHON_BIN="python"
else
  echo "Error: Python was not found in PATH." >&2
  exit 1
fi

if [[ ! -x "$VENV_DIR/bin/python" ]]; then
  echo "Creating virtual environment..."
  "$PYTHON_BIN" -m venv "$VENV_DIR"
fi

VENV_PYTHON="$VENV_DIR/bin/python"

if [[ -f "requirements.lock" ]]; then
  echo "Installing dependencies from requirements.lock..."
  "$VENV_PYTHON" -m pip install -r requirements.lock
else
  echo "Error: requirements.lock not found in $SCRIPT_DIR" >&2
  exit 1
fi

echo "Starting app..."
exec "$VENV_PYTHON" main.py "$@"
